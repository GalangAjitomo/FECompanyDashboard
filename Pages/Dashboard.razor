@page "/dashboard"
@attribute [Authorize]

@using FECompanyDashboard.Models
@using FECompanyDashboard.Services
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@inject IJSRuntime JS
@inject ProductionService Production

@if (IsLoading)
{
    <div class="loader-overlay">
        <div class="loader"></div>
    </div>
}

<MudGrid Class="mt-4">

    <!-- TITLE -->
    <MudItem xs="12">
        <MudText Typo="Typo.h5" Align="Align.Center">
            <b>Petrochemical Production Overview</b>
        </MudText>
        <MudText Typo="Typo.subtitle2" Align="Align.Center" Color="Color.Secondary">
            Ethylene & Polyethylene Plant Performance
        </MudText>
    </MudItem>

    <!-- DAILY ETHYLENE -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Style="height:340px;">
            <h3>Daily Ethylene Production (Ton/Day)</h3>
            <div class="chart-inner" style="height:260px;">
                <canvas id="ethyleneDailyChart"></canvas>
            </div>
        </MudPaper>
    </MudItem>

    <!-- MONTHLY POLYETHYLENE -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Style="height:340px;">
            <h3>Monthly Polyethylene Output (Ton)</h3>
            <div class="chart-inner" style="height:260px;">
                <canvas id="peMonthlyChart"></canvas>
            </div>
        </MudPaper>
    </MudItem>

    <!-- ACTUAL VS CAPACITY -->
    <MudItem xs="12" md="8">
        <MudPaper Class="pa-4" Style="height:340px;">
            <h3>Ethylene Actual vs Design Capacity</h3>
            <div class="chart-inner" style="height:260px;">
                <canvas id="capacityChart"></canvas>
            </div>
        </MudPaper>
    </MudItem>

    <!-- PRODUCT YIELD -->
    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4" Style="height:340px;">
            <h3>Product Yield Distribution (%)</h3>
            <div class="chart-inner" style="height:260px;">
                <canvas id="yieldChart"></canvas>
            </div>
        </MudPaper>
    </MudItem>

</MudGrid>

@code {

    private bool IsLoading = true;
    private bool _chartsRendered = false;

    List<TrendPoint> Daily = new();
    List<TrendPoint> Monthly = new();
    List<CapacityDto> Capacity = new();
    List<YieldDto> Yield = new();

    protected override async Task OnInitializedAsync()
    {
        // 🔐 API calls (JWT already handled in ProductionService)
        Daily = await Production.GetDailyTrendAsync();
        Monthly = await Production.GetMonthlyTrendAsync();
        Capacity = await Production.GetCapacityAsync();
        Yield = await Production.GetYieldAsync();

        IsLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_chartsRendered || IsLoading) return;
        _chartsRendered = true;

        // 1️⃣ DAILY LINE
        await JS.InvokeVoidAsync("productionCharts.drawLine", "ethyleneDailyChart", new
        {
            labels = Daily.Select(x => x.Date).ToArray(),
            datasets = new[]
            {
                new {
                    label = "Ethylene Actual",
                    data = Daily.Select(x => x.Value).ToArray(),
                    borderColor = "#006CB8",
                    backgroundColor = "rgba(0,108,184,0.15)",
                    fill = true,
                    pointRadius = 4
                }
            }
        });

        // 2️⃣ MONTHLY BAR
        await JS.InvokeVoidAsync("productionCharts.drawBar", "peMonthlyChart", new
        {
            labels = Monthly.Select(x => x.Date).ToArray(),
            datasets = new[]
            {
                new {
                    label = "Polyethylene",
                    data = Monthly.Select(x => x.Value).ToArray(),
                    backgroundColor = "#4CAF50"
                }
            }
        });

        // 3️⃣ CAPACITY COMPARISON
        await JS.InvokeVoidAsync("productionCharts.drawBar", "capacityChart", new
        {
            labels = Capacity.Select(x => x.Label).ToArray(),
            datasets = new[]
            {
                new {
                    label = "Actual",
                    data = Capacity.Select(x => x.Actual).ToArray(),
                    backgroundColor = "#2196F3"
                },
                new {
                    label = "Design Capacity",
                    data = Capacity.Select(x => x.Capacity).ToArray(),
                    backgroundColor = "#FFC107"
                }
            }
        });

        // 4️⃣ YIELD DONUT
        await JS.InvokeVoidAsync("productionCharts.drawDonut", "yieldChart", new
        {
            labels = Yield.Select(x => x.Product).ToArray(),
            datasets = new[]
            {
                new {
                    data = Yield.Select(x => x.Percentage).ToArray(),
                    backgroundColor = new[] { "#2196F3", "#4CAF50", "#FFC107" }
                }
            }
        });
    }
}
